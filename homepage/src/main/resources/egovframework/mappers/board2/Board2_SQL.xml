<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.let.board2.service.impl.Board2Mapper">
	
	<resultMap type="egovframework.let.board2.service.Board2VO" id="board2">
		<result property="boardId" column="BOARD_ID"/>
		<result property="boardSj" column="BOARD_SJ"/>
		<result property="boardCn" column="BOARD_CN"/>
		<result property="inqireCo" column="INQIRE_CO"/>
		<result property="creatIp" column="CREAT_IP"/>
		<result property="noticeAt" column="NOTICE_AT"/>
		<result property="othbcAt" column="OTHBC_AT"/>
		<result property="useAt" column="USE_AT"/>
		<result property="atchFileId" column="ATCH_FILE_ID"/>
		<result property="frstRegistPnttm" column="FRST_REGIST_PNTTM"/>
		<result property="frstRegisterId" column="FRST_REGISTER_ID"/>
	</resultMap>
	
	<select id="selectBoard2List" resultType="egovMap">
		SELECT
			A.BOARD_ID
			, A.BOARD_SJ
			, A.BOARD_CN
			, A.INQIRE_CO
			, A.CREAT_IP
			, A.NOTICE_AT
			, A.OTHBC_AT
			, A.USE_AT
			, A.ATCH_FILE_ID
			, A.FRST_REGIST_PNTTM
			, A.FRST_REGISTER_ID
			, A.LAST_UPDT_PNTTM
			, A.LAST_UPDUSR_ID
			, (SELECT
					CONCAT(X.STRE_FILE_NM, '.', X.FILE_EXTSN)
				FROM LETTNFILEDETAIL X
				WHERE X.ATCH_FILE_ID = A.ATCH_FILE_ID
					AND UPPER(FILE_EXTSN) IN('GIF','JPG','JPEG','BMP','PNG')
				ORDER BY FILE_SN
				LIMIT 1
			) AS ATCH_FILE_NM
		FROM BOARD2 A
		<!-- FROM BOARD A는 FROM BOARD AS A와 같음 -->
		<include refid="selectBoardListWhere"></include>
		ORDER BY A.FRST_REGIST_PNTTM DESC
		
		<if test='noticeAt != "Y"'>
			LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
		</if>
	</select>
	
	<select id="selectBoard2ListCnt" resultType="java.lang.Integer">
		SELECT
			COUNT(*) CNT
		FROM BOARD2 A
		<include refid="selectBoardListWhere"></include>
	</select>
	
<!-- 공통으로 사용하는 조건은 빼둔다. CONCAT : 문자열을 합쳐주는 명령어 -->
	<sql id="selectBoardListWhere">
		<where>
			A.USE_AT = "Y"
			<choose>
				<when test='noticeAt == "Y"'>
					AND A.NOTICE_AT = 'Y'
				</when>
				<otherwise>
					<if test='searchCondition != null and searchCondition != ""'>
						<choose>
							<when test="searchCondition == 0">
								AND A.BOARD_SJ LIKE CONCAT('%', #{searchKeyword}, '%')
							</when>
							<when test="searchCondition == 1">
								AND A.BOARD_CN LIKE CONCAT('%', #{searchKeyword}, '%')
							</when>
							<when test="searchCondition == 2">
								AND A.FRST_REGISTER_ID LIKE CONCAT('%', #{searchKeyword}, '%')
							</when>							
						</choose>
					</if>
				</otherwise>
			</choose>
		</where>
	</sql>
	
	<insert id="insertBoard2" parameterType="egovframework.let.board2.service.Board2VO">
		INSERT INTO BOARD2 (
			BOARD_ID
			, BOARD_SJ
			, BOARD_CN
			, INQIRE_CO
			, CREAT_IP
			, NOTICE_AT
			, OTHBC_AT
			, USE_AT
			, ATCH_FILE_ID
			, FRST_REGIST_PNTTM
			, FRST_REGISTER_ID
			, LAST_UPDT_PNTTM
			, LAST_UPDUSR_ID
		) VALUES (
			#{boardId}
			, #{boardSj}
			, #{boardCn}
			, 0
			, #{creatIp}
			, #{noticeAt}
			, #{othbcAt}
			, 'Y'
			, #{atchFileId}
			, NOW()
			, #{userId}
			, NOW()
			, #{userId}
		)
	</insert>
	
	<select id="selectBoard2" resultMap="board2">
		SELECT
			  BOARD_ID
			, BOARD_SJ
			, BOARD_CN
			, INQIRE_CO
			, CREAT_IP
			, NOTICE_AT
			, OTHBC_AT
			, USE_AT
			, ATCH_FILE_ID
			, FRST_REGIST_PNTTM
			, FRST_REGISTER_ID
		FROM BOARD2
		WHERE BOARD_ID = #{boardId}
			AND USE_AT = "Y" 
	</select>
	
<!-- 조회수 상승 -->
	<update id="updateViewCnt" parameterType="egovframework.let.board2.service.Board2VO">
		UPDATE BOARD2 SET
			INQIRE_CO = INQIRE_CO + 1
		WHERE BOARD_ID = #{boardId}
	</update>
	
	<update id="updateBoard2" parameterType="egovframework.let.board2.service.Board2VO">
		UPDATE BOARD2 SET
			BOARD_SJ = #{boardSj}
			, BOARD_CN = #{boardCn}
			, NOTICE_AT = #{noticeAt}
			, OTHBC_AT = #{othbcAt}
			<if test='atchFileId != null and atchFileId !=""'>
				, ATCH_FILE_ID = #{atchFileId}
			</if>
			, LAST_UPDT_PNTTM = #{lastUpdtPnttm}
			, LAST_UPDUSR_ID = #{lastUpdusrId}
		WHERE BOARD_ID = #{boardId} 
		<if test='mngAt != "Y"'>		
			AND FRST_REGISTER_ID = #{userId}
		</if>
	</update>
	
	<update id="deleteBoard2" parameterType="egovframework.let.board2.service.Board2VO">
		UPDATE BOARD2 SET
			USE_AT = 'N'
		WHERE BOARD_ID = #{boardId}
		<if test='mngAt != "Y"'>		
			AND FRST_REGISTER_ID = #{userId}
		</if>
	</update>
</mapper>